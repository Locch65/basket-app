<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Statistiche Avanzate Roster</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
  * {
    -webkit-user-select: none;
    -ms-user-select: none;
    user-select: none;
    -webkit-touch-callout: none;
  }

  body { 
    font-family: Arial, sans-serif; 
    margin: 10px; 
    background: #f5f5f5; 
    display: flex;
    flex-direction: column;
  }
  
  .header-container { 
    display: flex; align-items: center; justify-content: space-between; 
    margin-bottom: 15px; background: #fff; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
   
  .brand-section {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .home-btn { 
    text-decoration: none; 
    color: #007bff; 
    font-size: 24px; /* Dimensione dell'icona */
    display: flex; 
    align-items: center; 
  }
  .app-icon {
    width: 32px;
    height: 32px;
    object-fit: contain;
  }

  .header-container h2 {
    margin: 0;
    font-size: 1.1rem;
    color: #333;
  }
  
  .filters-container { 
    background: #fff; 
    padding: 15px; 
    border-radius: 8px; 
    margin-bottom: 10px; 
    box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
    display: flex; 
    gap: 20px; 
    flex-wrap: wrap;
  }

  .table-container {
    width: 100%;
    overflow-x: auto; 
    -webkit-overflow-scrolling: touch;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  }

  table { 
    width: 100%; 
    border-collapse: collapse; 
    min-width: 0 !important; /* Rimuove il limite dei 400px */
    table-layout: fixed; /* Fondamentale: forza le colonne a rispettare le larghezze */
  }

  th, td { 
    padding: 10px 2px !important; /* Forza un padding minimo */
    text-align: center; 
    border-bottom: 1px solid #ddd; 
  }
  th { background-color: #007bff; color: white; font-size: 12px; cursor: pointer; white-space: nowrap; position: relative; }
  
  th.sort-asc::after { content: " ▲"; font-size: 0.7em; }
  th.sort-desc::after { content: " ▼"; font-size: 0.7em; }

  .col-nome { 
    text-align: left; 
    width: 90px !important;    /* Forza la larghezza a 90px */
    max-width: 90px !important; 
    min-width: 0 !important;   /* Rimuove ogni limite minimo precedente */    white-space: nowrap; 
    overflow: hidden;
    text-overflow: ellipsis; 
  }
  .update-btn { 
    background: #28a745; 
    color: white; 
    border: none; 
    padding: 6px 12px; 
    border-radius: 5px; 
    font-size: 12px;
  }
  
  .pts-bold { color: #007bff; font-weight: bold; }
  .tfoot-totale { background-color: #e9f4ff; font-weight: bold; }
</style>
</head>
<body>

  <div class="header-container">
    <div class="brand-section">
      <a href="index.html" class="home-btn" aria-label="Home">
        <i class="fas fa-home"></i>
      </a>
      <img src="icon-192.png" alt="Logo" class="app-icon">
      <h2>Polismile A - U14</h2>
    </div>
    <button class="update-btn" onclick="forzaAggiornamento()">Aggiorna</button>
  </div>

  <div class="filters-container">
    <div class="filter-group">
      <strong>Campionato:</strong>
      <label><input type="radio" name="catFilter" value="U14" onclick="applicaFiltriECalcoli()"> U14</label>
      <label><input type="radio" name="catFilter" value="U15" onclick="applicaFiltriECalcoli()"> U15</label>
      <label><input type="radio" name="catFilter" value="Tutti" checked onclick="applicaFiltriECalcoli()"> Tutti</label>
    </div>
    
    <div class="filter-group">
      <strong>Punti:</strong>
      <label><input type="radio" name="calcType" value="Totale" checked onclick="applicaFiltriECalcoli()"> Somma</label>
      <label><input type="radio" name="calcType" value="Media" onclick="applicaFiltriECalcoli()"> Media</label>
    </div>
  </div>

  <div id="loading" class="loading">Calcolo statistiche in corso...</div>

  <div class="table-container">
    <table id="roster-table" style="display:none;">
      <thead>
        <tr>
          <th onclick="gestisciClickOrdinamento('Numero Maglia')">#</th>
          <th class="col-nome" onclick="gestisciClickOrdinamento('Cognome')">Giocatore</th>
          <th onclick="gestisciClickOrdinamento('partite')">PG</th>
          <th onclick="gestisciClickOrdinamento('punti')">PTS</th>
          <th onclick="gestisciClickOrdinamento('tl')">TL</th>
          <th onclick="gestisciClickOrdinamento('t2')">T2</th>
          <th onclick="gestisciClickOrdinamento('t3')">T3</th>
        </tr>
      </thead>
      <tbody id="table-body"></tbody>
      <tfoot id="table-foot"></tfoot>
    </table>
  </div>

  <script src="common.js?v=1.0.90"></script>
  <script>
    let datiOriginali = []; 
    let datiFinali = [];    
    let statoOrdine = JSON.parse(localStorage.getItem("statoOrdineStats")) || { colonna: 'punti', ascendente: false };

    async function inizializzaDati() {
      const cacheRoster = localStorage.getItem("datiRoster");
      const cacheStats = localStorage.getItem("datiTutteLeStats");

      let roster, stats;

      if (cacheRoster && cacheStats) {
        roster = JSON.parse(cacheRoster);
        stats = JSON.parse(cacheStats);
      } else {
        try {
          const [resRoster, resStats] = await Promise.all([
            fetch(url + "?sheet=Roster"),
            fetch(url + "?getAllStats=1")
          ]);
          roster = await resRoster.json();
          stats = await resStats.json();
          localStorage.setItem("datiRoster", JSON.stringify(roster));
          localStorage.setItem("datiTutteLeStats", JSON.stringify(stats));
        } catch (e) {
          document.getElementById("loading").innerText = "Errore nel caricamento dati dal server.";
          return;
        }
      }
      mappaAzioniGiocatori(roster, stats);
    }

    function mappaAzioniGiocatori(roster, stats) {
      datiOriginali = roster.map((player, index) => {
        const azioniGiocatore = stats.statisticheGiocatori.filter(s => 
          s.giocatore === player.Nome + " " + player.Cognome || 
          (s.numero == player["Numero Maglia"] && s.giocatore.includes(player.Cognome))
        );
        return {
          ...player,
          indiceOriginale: index,
          azioni: azioniGiocatore
        };
      });
      applicaFiltriECalcoli();
    }

    function applicaFiltriECalcoli() {
      const categoria = document.querySelector('input[name="catFilter"]:checked').value;
      const tipoCalcolo = document.querySelector('input[name="calcType"]:checked').value;

      datiFinali = datiOriginali.map(player => {
        const azioniFiltrate = player.azioni.filter(a => {
          const id = a.matchId ? String(a.matchId) : "";
          if (categoria === "Tutti") return id.includes("U14") || id.includes("U15");
          return id.includes(categoria);
        });
        
        const matchIds = [...new Set(azioniFiltrate.map(s => s.matchId))];
        let tl = 0, t2 = 0, t3 = 0, puntiTotali = 0;
        
        azioniFiltrate.forEach(s => {
          try {
            const dettagli = JSON.parse(s.dettagli || "{}");
            tl += parseInt(dettagli["1"]) || 0;
            t2 += parseInt(dettagli["2"]) || 0;
            t3 += parseInt(dettagli["3"]) || 0;
          } catch (e) {}
        });

        puntiTotali = (tl * 1) + (t2 * 2) + (t3 * 3);
        const pg = matchIds.length;
        const divisore = (tipoCalcolo === "Media" && pg > 0) ? pg : 1;

        return {
          ...player,
          partite: pg,
          punti: tipoCalcolo === "Media" ? (puntiTotali / divisore).toFixed(1) : puntiTotali,
          tl: tipoCalcolo === "Media" ? (tl / divisore).toFixed(1) : tl,
          t2: tipoCalcolo === "Media" ? (t2 / divisore).toFixed(1) : t2,
          t3: tipoCalcolo === "Media" ? (t3 / divisore).toFixed(1) : t3,
          matchIdsFiltrati: matchIds // Teniamo traccia degli ID per il totale squadra
        };
      });

      applicaOrdinamento();
    }

    function renderTable() {
      const tbody = document.getElementById("table-body");
      const tfoot = document.getElementById("table-foot");
      document.getElementById("loading").style.display = "none";
      document.getElementById("roster-table").style.display = "table";
      
      tbody.innerHTML = ""; 
      
      let setPartiteSquadra = new Set();
      let totPTS = 0, totTL = 0, totT2 = 0, totT3 = 0;

      datiFinali.forEach((p) => {
        // Aggiungiamo i matchId di questa giocatrice al Set generale della squadra
        if(p.matchIdsFiltrati) {
          p.matchIdsFiltrati.forEach(id => setPartiteSquadra.add(id));
        }
        
        totPTS += parseFloat(p.punti) || 0;
        totTL += parseFloat(p.tl) || 0;
        totT2 += parseFloat(p.t2) || 0;
        totT3 += parseFloat(p.t3) || 0;

        const row = document.createElement("tr");
        row.onclick = () => { window.location.href = `anagrafica.html?player=${p.indiceOriginale}`; };
        
        row.innerHTML = `
          <td><strong>${p["Numero Maglia"]}</strong></td>
          <td class="col-nome">${p.Cognome} ${p.Nome.charAt(0)}.</td>
          <td>${p.partite}</td>
          <td class="pts-bold">${p.punti}</td>
          <td>${p.tl}</td>
          <td>${p.t2}</td>
          <td>${p.t3}</td>
        `;
        tbody.appendChild(row);
      });

      // Il numero di partite totali della squadra è la dimensione del Set (ID univoci)
      const totPG_Squadra = setPartiteSquadra.size;

      tfoot.innerHTML = `
        <tr class="tfoot-totale">
          <td></td>
          <td class="col-nome">TOTALE / MEDIA</td>
          <td>${totPG_Squadra}</td>
          <td class="pts-bold">${totPTS.toFixed(totPTS % 1 === 0 ? 0 : 1)}</td>
          <td>${totTL.toFixed(totTL % 1 === 0 ? 0 : 1)}</td>
          <td>${totT2.toFixed(totT2 % 1 === 0 ? 0 : 1)}</td>
          <td>${totT3.toFixed(totT3 % 1 === 0 ? 0 : 1)}</td>
        </tr>
      `;
    }

    function gestisciClickOrdinamento(colonna) {
      if (statoOrdine.colonna === colonna) {
        statoOrdine.ascendente = !statoOrdine.ascendente;
      } else {
        statoOrdine.colonna = colonna;
        statoOrdine.ascendente = (colonna === 'Cognome'); 
      }
      localStorage.setItem("statoOrdineStats", JSON.stringify(statoOrdine));
      applicaOrdinamento();
    }

    function applicaOrdinamento() {
      datiFinali.sort((a, b) => {
        let vA = a[statoOrdine.colonna];
        let vB = b[statoOrdine.colonna];
        
        if (statoOrdine.colonna !== 'Cognome') {
          vA = parseFloat(vA) || 0;
          vB = parseFloat(vB) || 0;
        }

        if (typeof vA === 'string') {
          return statoOrdine.ascendente ? vA.localeCompare(vB) : vB.localeCompare(vA);
        }
        return statoOrdine.ascendente ? vA - vB : vB - vA;
      });
      
      aggiornaIconeHeader();
      renderTable();
    }

    function aggiornaIconeHeader() {
      const headers = document.querySelectorAll('th');
      const mappatura = {
        'Numero Maglia': '#', 'Cognome': 'Giocatore', 'partite': 'PG',
        'punti': 'PTS', 'tl': 'TL', 't2': 'T2', 't3': 'T3'
      };
      headers.forEach(th => {
        th.classList.remove('sort-asc', 'sort-desc');
        const testoPulito = th.innerText.replace(/[▲▼]/g, '').trim();
        if (testoPulito === mappatura[statoOrdine.colonna]) {
          th.classList.add(statoOrdine.ascendente ? 'sort-asc' : 'sort-desc');
        }
      });
    }

    function forzaAggiornamento() {
      localStorage.removeItem("datiRoster");
      localStorage.removeItem("datiTutteLeStats");
      location.reload();
    }

    inizializzaDati();
  </script>
</body>
</html>