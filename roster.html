<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Statistiche Avanzate Roster</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; margin: 10px; background: #f5f5f5; }
    .header-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0px; }
    
    .filters-container { 
      background: #fff; 
      padding: 15px; 
      border-radius: 8px; 
      margin-bottom: 6px; 
      box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
      display: flex; 
      gap: 20px; 
      flex-wrap: wrap;
    }
    .filter-group { display: flex; align-items: center; gap: 10px; }
    .filter-group label { cursor: pointer; display: flex; align-items: center; gap: 4px; }

    table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.1); font-size: 14px; }
    th, td { padding: 12px 10px; text-align: center; border-bottom: 1px solid #ddd; }
    th { background-color: #007bff; color: white; cursor: pointer; user-select: none; }
    th:hover { background-color: #0056b3; }
    .col-nome { text-align: left; min-width: 100px; }
    tr:hover { background-color: #f1f1f1; cursor: pointer; }
    .update-btn { background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }
    .loading { text-align: center; padding: 20px; font-weight: bold; color: #666; }
    th.sort-asc::after { content: " ▲"; font-size: 0.7em; }
    th.sort-desc::after { content: " ▼"; font-size: 0.7em; }
    .pts-bold { color: #007bff; font-weight: bold; }
  </style>
</head>
<body>

  <div class="header-container">
    <h2>Polismile A</h2>
    <button class="update-btn" onclick="forzaAggiornamento()">Aggiorna Dati</button>
  </div>

  <div class="filters-container">
    <div class="filter-group">
      <strong>Categoria:</strong>
      <label><input type="radio" name="catFilter" value="Tutti" checked onclick="applicaFiltriECalcoli()"> Tutti</label>
      <label><input type="radio" name="catFilter" value="U14" onclick="applicaFiltriECalcoli()"> U14</label>
      <label><input type="radio" name="catFilter" value="U15" onclick="applicaFiltriECalcoli()"> U15</label>
    </div>
    
    <div class="filter-group">
      <strong>Visualizzazione:</strong>
      <label><input type="radio" name="calcType" value="Totale" checked onclick="applicaFiltriECalcoli()"> Totale</label>
      <label><input type="radio" name="calcType" value="Media" onclick="applicaFiltriECalcoli()"> Media</label>
    </div>
  </div>

  <div id="loading" class="loading">Calcolo statistiche in corso...</div>

  <table id="roster-table" style="display:none;">
    <thead>
      <tr>
        <th onclick="gestisciClickOrdinamento('Numero Maglia')">#</th>
        <th class="col-nome" onclick="gestisciClickOrdinamento('Cognome')">Giocatore</th>
        <th onclick="gestisciClickOrdinamento('partite')">PG</th>
        <th onclick="gestisciClickOrdinamento('punti')">PTS</th>
        <th onclick="gestisciClickOrdinamento('tl')">TL</th>
        <th onclick="gestisciClickOrdinamento('t2')">T2</th>
        <th onclick="gestisciClickOrdinamento('t3')">T3</th>
      </tr>
    </thead>
    <tbody id="table-body"></tbody>
  </table>

  <script src="common.js?v=1.0.87"></script>
  <script>
    let datiOriginali = []; 
    let datiFinali = [];    
    let statoOrdine = JSON.parse(localStorage.getItem("statoOrdineStats")) || { colonna: 'punti', ascendente: false };

    async function inizializzaDati() {
      const cacheRoster = localStorage.getItem("datiRoster");
      const cacheStats = localStorage.getItem("datiTutteLeStats");

      let roster, stats;

      if (cacheRoster && cacheStats) {
        roster = JSON.parse(cacheRoster);
        stats = JSON.parse(cacheStats);
      } else {
        try {
          const [resRoster, resStats] = await Promise.all([
            fetch(url + "?sheet=Roster"),
            fetch(url + "?getAllStats=1")
          ]);
          roster = await resRoster.json();
          stats = await resStats.json();
          localStorage.setItem("datiRoster", JSON.stringify(roster));
          localStorage.setItem("datiTutteLeStats", JSON.stringify(stats));
        } catch (e) {
          document.getElementById("loading").innerText = "Errore nel caricamento dati dal server.";
          return;
        }
      }
      mappaAzioniGiocatori(roster, stats);
    }

    function mappaAzioniGiocatori(roster, stats) {
      datiOriginali = roster.map((player, index) => {
        const azioniGiocatore = stats.statisticheGiocatori.filter(s => 
          s.giocatore === player.Nome + " " + player.Cognome || 
          (s.numero == player["Numero Maglia"] && s.giocatore.includes(player.Cognome))
        );
        return {
          ...player,
          indiceOriginale: index,
          azioni: azioniGiocatore
        };
      });
      applicaFiltriECalcoli();
    }

    function applicaFiltriECalcoli() {
      const categoria = document.querySelector('input[name="catFilter"]:checked').value;
      const tipoCalcolo = document.querySelector('input[name="calcType"]:checked').value;

      datiFinali = datiOriginali.map(player => {
        // CORREZIONE: Controllo robusto sul matchId trasformandolo sempre in stringa
        const azioniFiltrate = player.azioni.filter(a => {
          const id = a.matchId ? String(a.matchId) : "";
          if (categoria === "Tutti") return id.includes("U14") || id.includes("U15");
          return id.includes(categoria);
        });
        
        const matchIds = [...new Set(azioniFiltrate.map(s => s.matchId))];
        let tl = 0, t2 = 0, t3 = 0, puntiTotali = 0;
        
        azioniFiltrate.forEach(s => {
          try {
            const dettagli = JSON.parse(s.dettagli || "{}");
            tl += parseInt(dettagli["1"]) || 0;
            t2 += parseInt(dettagli["2"]) || 0;
            t3 += parseInt(dettagli["3"]) || 0;
          } catch (e) {}
        });

        puntiTotali = (tl * 1) + (t2 * 2) + (t3 * 3);
        const pg = matchIds.length;
        const divisore = (tipoCalcolo === "Media" && pg > 0) ? pg : 1;

        return {
          ...player,
          partite: pg,
          punti: tipoCalcolo === "Media" ? (puntiTotali / divisore).toFixed(1) : puntiTotali,
          tl: tipoCalcolo === "Media" ? (tl / divisore).toFixed(1) : tl,
          t2: tipoCalcolo === "Media" ? (t2 / divisore).toFixed(1) : t2,
          t3: tipoCalcolo === "Media" ? (t3 / divisore).toFixed(1) : t3
        };
      });

      applicaOrdinamento();
    }

    function renderTable() {
      const tbody = document.getElementById("table-body");
      document.getElementById("loading").style.display = "none";
      document.getElementById("roster-table").style.display = "table";
      tbody.innerHTML = ""; 

      datiFinali.forEach((p) => {
        const row = document.createElement("tr");
        row.onclick = () => { window.location.href = `anagrafica.html?player=${p.indiceOriginale}`; };
        
        row.innerHTML = `
          <td><strong>${p["Numero Maglia"]}</strong></td>
          <td class="col-nome">${p.Cognome} ${p.Nome}</td>
          <td>${p.partite}</td>
          <td class="pts-bold">${p.punti}</td>
          <td>${p.tl}</td>
          <td>${p.t2}</td>
          <td>${p.t3}</td>
        `;
        tbody.appendChild(row);
      });
    }

    function gestisciClickOrdinamento(colonna) {
      if (statoOrdine.colonna === colonna) {
        statoOrdine.ascendente = !statoOrdine.ascendente;
      } else {
        statoOrdine.colonna = colonna;
        statoOrdine.ascendente = (colonna === 'Cognome'); 
      }
      localStorage.setItem("statoOrdineStats", JSON.stringify(statoOrdine));
      applicaOrdinamento();
    }

    function applicaOrdinamento() {
      datiFinali.sort((a, b) => {
        let vA = a[statoOrdine.colonna];
        let vB = b[statoOrdine.colonna];
        
        if (statoOrdine.colonna !== 'Cognome') {
          vA = parseFloat(vA) || 0;
          vB = parseFloat(vB) || 0;
        }

        aggiornaIconeHeader();

        if (typeof vA === 'string') {
          return statoOrdine.ascendente ? vA.localeCompare(vB) : vB.localeCompare(vA);
        }
        return statoOrdine.ascendente ? vA - vB : vB - vA;
      });
      renderTable();
    }

    function aggiornaIconeHeader() {
      const headers = document.querySelectorAll('th');
      const mappatura = {
        'Numero Maglia': '#', 'Cognome': 'Giocatore', 'partite': 'PG',
        'punti': 'PTS', 'tl': 'TL', 't2': 'T2', 't3': 'T3'
      };
      headers.forEach(th => {
        th.classList.remove('sort-asc', 'sort-desc');
        if (th.innerText.includes(mappatura[statoOrdine.colonna])) {
          th.classList.add(statoOrdine.ascendente ? 'sort-asc' : 'sort-desc');
        }
      });
    }

    function forzaAggiornamento() {
      localStorage.removeItem("datiRoster");
      localStorage.removeItem("datiTutteLeStats");
      location.reload();
    }

    inizializzaDati();
  </script>
</body>
</html>
