<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Seleziona Partita</title>
  <link rel="stylesheet" href="style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
  <h1>Calendario</h1>
  <button id="toggleTheme">ğŸŒ™</button>
  <div id="listaPartite" class="loading">Caricamento Calendario...</div>

  <script>
    const url = 
     "https://script.google.com/macros/s/AKfycbxMw2S8EwK42prjk0OQCY6RLUl-Erd-d4TW5lx8mWnB5yG5-KJywz6enMqF6wmLnxBWOQ/exec";

    // ğŸ”§ Parsing data in formato dd/MM/YYYY
    function parseItalianDate(dateStr, timeStr) {
      const [giorno, mese, anno] = dateStr.split("/").map(Number);
      const [ore, minuti] = timeStr.split(":").map(Number);
      return new Date(anno, mese - 1, giorno, ore, minuti);
    }

    function caricaListaPartite() {
      const container = document.getElementById("listaPartite");
      container.textContent = "Sto caricando il Calendario...";

      fetch(url + "?sheet=Partite")
        .then(res => res.json())
        .then(data => {
          container.classList.remove("loading");
          const partite = Array.isArray(data) ? data : data.data;
		  console.log("Caricate le partite:", partite);
          if (!Array.isArray(partite) || partite.length === 0) {
            container.textContent = "Nessuna partita disponibile";
            return;
          }

          const frag = document.createDocumentFragment();
          const oggi = new Date();

          partite.forEach(p => {
            const card = document.createElement("div");
            card.classList.add("match-card");

            // ğŸ”§ Controllo se la partita Ã¨ nel passato
            const dataPartita = parseItalianDate(p.data, p.orario);
            if (dataPartita < oggi) {
              card.classList.add("past");
            }

            const casaIcon = "ğŸ ";
            const trasfertaIcon = "ğŸšŒ";
            const icona = (p.casaTrasferta === "Casa") ? casaIcon : trasfertaIcon;

            card.innerHTML = `
              <div class="match-top">
                <span class="match-id">${p.matchId}</span>
                <span class="data">${p.data}</span>
                <span class="orario">${p.orario}</span>
              </div>
              <div class="match-middle">
                <span class="casa">${icona}</span>
                <span class="luogo">${p.luogo}</span>
              </div>
              <div class="match-bottom">
                <span class="teamA">${p.squadraA} <strong>${p.punteggioA ?? "-"}</strong></span>
                <span class="vs">vs</span>
                <span class="teamB"><strong>${p.punteggioB ?? "-"}</strong> ${p.squadraB}</span>
              </div>
            `;

            card.addEventListener("click", () => {
              localStorage.setItem("matchId", p.matchId);
              localStorage.setItem("teamA", p.squadraA);
              localStorage.setItem("teamB", p.squadraB);
              window.location.href = "app.html";
            });

            frag.appendChild(card);
          });

          container.replaceChildren(frag);
        })
        .catch(err => {
          container.classList.remove("loading");
          container.textContent = "Errore caricamento partite: " + err.message;
          console.error(err);
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
      caricaListaPartite();

      // ğŸ”§ Ripristina tema salvato
      const savedTheme = localStorage.getItem("theme");
      if (savedTheme === "dark") {
        document.body.classList.add("dark-mode");
        document.getElementById("toggleTheme").textContent = "â˜€ï¸";
      }

      // Toggle Dark Mode con salvataggio
      document.getElementById("toggleTheme").addEventListener("click", () => {
        document.body.classList.toggle("dark-mode");
        const isDark = document.body.classList.contains("dark-mode");
        localStorage.setItem("theme", isDark ? "dark" : "light");
        document.getElementById("toggleTheme").textContent = isDark ? "â˜€ï¸" : "ğŸŒ™";
      });
    });
  </script>
</body>
</html>
